openapi: 3.0.1
info:
  title: Seiwa Finance API V1
  version: v1
  description: API para gerenciamento financeiro de médicos e eventos financeiros
servers:
  - url: http://localhost:3000
    variables:
      defaultHost:
        default: localhost:3000
paths:
  /doctors:
    post:
      tags:
        - Doctors
      summary: Cadastrar médico
      description: |
        Registra um novo médico no sistema.
        
        Campos obrigatórios:
        - **name**: Nome do médico
        - **crm**: CRM do médico (deve ser único)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                doctor:
                  type: object
                  properties:
                    name:
                      type: string
                      example: Dr. Bruno
                    crm:
                      type: string
                      example: "123456"
                  required:
                    - name
                    - crm
      responses:
        '201':
          description: doctor created
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  name:
                    type: string
                  crm:
                    type: string
                required:
                  - id
                  - name
                  - crm
        '422':
          description: invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /doctors/{id}/balance:
    get:
      tags:
        - Doctors
      summary: Consultar saldo consolidado de um médico por período
      description: |
        Retorna o saldo consolidado de um médico para um período específico.
        
        O saldo é calculado como:
        - **production_total**: Soma de todas as produções no período
        - **payout_total**: Soma de todos os repasses no período
        - **net_balance**: Saldo líquido (production_total - payout_total)
        
        Apenas eventos dentro do período especificado são considerados no cálculo.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: Doctor ID
        - name: start_date
          in: query
          required: true
          schema:
            type: string
            format: date
          description: Start date (YYYY-MM-DD)
          example: '2024-01-01'
        - name: end_date
          in: query
          required: true
          schema:
            type: string
            format: date
          description: End date (YYYY-MM-DD)
          example: '2024-01-31'
      responses:
        '200':
          description: balance retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BalanceReport'
        '404':
          description: doctor not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /financial_events:
    post:
      tags:
        - Financial Events
      summary: Criar evento financeiro (produção ou repasse)
      description: |
        Este endpoint permite registrar tanto **produções** quanto **repasses**.
        
        - **Produção**: Use `event_type: "production"` para registrar uma produção (valor positivo no saldo)
        - **Repasse**: Use `event_type: "payout"` para registrar um repasse (valor negativo no saldo)
        
        Exemplo de produção:
        ```json
        {
          "financial_event": {
            "doctor_id": 1,
            "event_type": "production",
            "amount": 5000.00,
            "date": "2024-01-15",
            "hospital": "Hospital A"
          }
        }
        ```
        
        Exemplo de repasse:
        ```json
        {
          "financial_event": {
            "doctor_id": 1,
            "event_type": "payout",
            "amount": 2000.00,
            "date": "2024-01-15",
            "hospital": "Hospital B"
          }
        }
        ```
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                financial_event:
                  type: object
                  properties:
                    doctor_id:
                      type: integer
                      description: ID do médico
                      example: 1
                    event_type:
                      type: string
                      enum:
                        - production
                        - payout
                      description: Tipo do evento - "production" para produção, "payout" para repasse
                      example: production
                    amount:
                      type: number
                      format: float
                      description: Valor do evento (deve ser maior que zero)
                      example: 1000.00
                    date:
                      type: string
                      format: date
                      description: Data do evento (formato YYYY-MM-DD)
                      example: '2024-01-15'
                    hospital:
                      type: string
                      description: Nome do hospital
                      example: Hospital Teste
                  required:
                    - doctor_id
                    - event_type
                    - amount
                    - date
                    - hospital
            examples:
              production:
                summary: Exemplo de produção
                value:
                  financial_event:
                    doctor_id: 1
                    event_type: production
                    amount: 5000.00
                    date: '2024-01-15'
                    hospital: Hospital A
              payout:
                summary: Exemplo de repasse
                value:
                  financial_event:
                    doctor_id: 1
                    event_type: payout
                    amount: 2000.00
                    date: '2024-01-15'
                    hospital: Hospital B
      responses:
        '201':
          description: Evento financeiro criado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FinancialEvent'
        '422':
          description: Dados inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
components:
  schemas:
    Doctor:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        crm:
          type: string
      required:
        - name
        - crm
    FinancialEvent:
      type: object
      properties:
        id:
          type: integer
        doctor_id:
          type: integer
        event_type:
          type: string
          enum:
            - production
            - payout
        amount:
          type: number
          format: float
        date:
          type: string
          format: date
        hospital:
          type: string
      required:
        - doctor_id
        - event_type
        - amount
        - date
        - hospital
    BalanceReport:
      type: object
      properties:
        doctor_name:
          type: string
        crm:
          type: string
        period:
          type: object
          properties:
            start:
              type: string
              format: date
            end:
              type: string
              format: date
        production_total:
          type: number
          format: float
        payout_total:
          type: number
          format: float
        net_balance:
          type: number
          format: float
    Error:
      type: object
      properties:
        errors:
          type: object
